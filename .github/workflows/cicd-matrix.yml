name: Deploy Applications to Azure Web App

on:
  push:
    branches:
      - cicd
env:
  AZURE_WEBAPP_NAME: "as-lara"
  # NUGET_VERSION: '4.6.1'
  BUILD_CONFIGURATION: "Release"

jobs:

 backwords-compatibility:
    # Dynamically set the job name based on the application name
    name: ${{ matrix.name }}
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - { path: PG.LARA.ValidationSummaryReport.WebJob, name: NotifyMetadataValidation, type: Triggered }
          - { path: PG.LARA.GenerateValidationSummary.WebJob, name: GenerateValidationSummary, type: Triggered }
          - { path: PG.LARA.GeneratesJDATemplates.WebJob, name: GenerateTMSOutputTemplates, type: Triggered }
    steps:

      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Check Visual Studio Installer Path
        run: |
         if (Test-Path "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\vs_installer.exe") {
           Write-Output "Visual Studio Installer found."
         } else {
           Write-Output "Visual Studio Installer not found."
           exit 1
         }
      - name: Install .NET Framework 4.6.1 using Visual Studio Installer
        run: |
         Start-Process "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\vs_installer.exe" `
         -ArgumentList "modify --add Microsoft.Net.Component.4.6.1.TargetingPack --quiet --norestart" `
         -NoNewWindow -Wait
      # - name: Install Nuget
      #   uses: nuget/setup-nuget@v1
      #   with:
      #     nuget-version: ${{ env.NUGET_VERSION}}
          
      # - name: Install .NET Framework 4.6.1 Developer Pack
      #   run: |
      #      choco install netfx-4.6.1-devpack -y

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v1

      - name: Restore NuGet Packages
        run: nuget restore ${{ matrix.path }}/PG.LARA.${{ matrix.name }}.WebJob.csproj

      - name: Build Application (${{ matrix.include.name }})
        run: |
          msbuild ${{ matrix.path }}/PG.LARA.${{ matrix.name }}.WebJob.csproj `
            /p:Configuration=${{ env.BUILD_CONFIGURATION }} `
            /p:DeployOnBuild=true `
            /p:OutputPath=./publish/App_Data/jobs/${{ matrix.type }}/DEV-${{ matrix.name }}
